# 24 . **Hive Query Language (HQL)**

Hive Query Language (HQL) is the SQL-like query language used to interact with **Hive**. It is designed for querying, managing, and analyzing large datasets stored in **HDFS** (Hadoop Distributed File System) or **HBase**. HQL supports many of the standard SQL operations but is optimized for Hadoop’s distributed nature.

---

## **1. Basic Querying with SELECT, WHERE, and GROUP BY**

## **1.1 SELECT Query**

A **SELECT** query retrieves data from a table in Hive. The basic structure is similar to SQL and is used to extract specific columns or all columns from a table.

**Syntax**:

```sql
SELECT column1, column2 FROM table_name;
```

To select all columns:

```sql
SELECT * FROM employees;
```

## **1.2 WHERE Clause**

The **WHERE** clause is used to filter rows based on a given condition. This clause works similarly to SQL, allowing you to specify conditions for selecting rows.

**Syntax**:

```sql
SELECT column1, column2 FROM table_name WHERE condition;
```

**Example**:

```sql
SELECT name, age FROM employees WHERE age > 30;
```

This query selects the `name` and `age` columns from the `employees` table where the age is greater than 30.

## **1.3 GROUP BY Clause**

The **GROUP BY** clause is used to group rows that have the same values in specified columns and allow for aggregation functions to be performed on those groups.

**Syntax**:

```sql
SELECT column1, COUNT(*) FROM table_name GROUP BY column1;
```

**Example**:

```sql
SELECT department, COUNT(*) FROM employees GROUP BY department;
```

This query groups the employees by their `department` and counts the number of employees in each department.

---

## **2. JOIN Operations in Hive**

Hive supports different types of **JOINs** for combining rows from two or more tables based on a related column. The basic **JOIN types** in Hive are:

1. **INNER JOIN**
2. **LEFT JOIN (LEFT OUTER JOIN)**
3. **RIGHT JOIN (RIGHT OUTER JOIN)**
4. **FULL OUTER JOIN**

## **2.1 INNER JOIN**

An **INNER JOIN** returns only the rows that have matching values in both tables.

**Syntax**:

```sql
SELECT column1, column2 FROM table1 t1
JOIN table2 t2
ON t1.id = t2.id;
```

**Example**:

```sql
SELECT e.id, e.name, d.department_name
FROM employees e
JOIN departments d
ON e.department_id = d.id;
```

This query performs an inner join between the `employees` table and the `departments` table, returning rows where the `department_id` matches.

## **2.2 LEFT JOIN (LEFT OUTER JOIN)**

A **LEFT JOIN** returns all rows from the left table, and the matching rows from the right table. If there is no match, NULL values are returned for columns from the right table.

**Syntax**:

```sql
SELECT column1, column2 FROM table1 t1
LEFT JOIN table2 t2
ON t1.id = t2.id;
```

**Example**:

```sql
SELECT e.id, e.name, d.department_name
FROM employees e
LEFT JOIN departments d
ON e.department_id = d.id;
```

This query returns all employees, including those who don’t belong to any department (with NULL in `department_name`).

## **2.3 RIGHT JOIN (RIGHT OUTER JOIN)**

A **RIGHT JOIN** returns all rows from the right table and the matching rows from the left table. If there is no match, NULL values are returned for columns from the left table.

**Syntax**:

```sql
SELECT column1, column2 FROM table1 t1
RIGHT JOIN table2 t2
ON t1.id = t2.id;
```

## **2.4 FULL OUTER JOIN**

A **FULL OUTER JOIN** returns all rows when there is a match in one of the tables. It returns NULL values for non-matching rows from both tables.

**Syntax**:

```sql
SELECT column1, column2 FROM table1 t1
FULL OUTER JOIN table2 t2
ON t1.id = t2.id;
```

---

## **3. Aggregations and Functions in Hive**

Hive supports a variety of **aggregation functions** and **built-in functions** that enable complex queries and analytics on large datasets. These functions help with summarizing and analyzing data.

## **3.1 Aggregation Functions**

* **COUNT**: Counts the number of rows.
* **SUM**: Sums up the values in a column.
* **AVG**: Returns the average of the values in a column.
* **MIN**: Returns the minimum value from a column.
* **MAX**: Returns the maximum value from a column.

**Example**:

```sql
SELECT department, COUNT(*) AS num_employees, AVG(age) AS avg_age
FROM employees
GROUP BY department;
```

This query counts the number of employees and calculates the average age for each department.

## **3.2 Other Useful Functions**

* **GROUP\_CONCAT**: Concatenates values in a group.

  ```sql
  SELECT department, GROUP_CONCAT(name) AS employees
  FROM employees
  GROUP BY department;
  ```

* **CONCAT**: Concatenates two or more strings.

  ```sql
  SELECT CONCAT(first_name, ' ', last_name) AS full_name
  FROM employees;
  ```

* **CAST**: Casts one data type to another.

  ```sql
  SELECT CAST(age AS STRING) FROM employees;
  ```

---

## **4. Subqueries and Nested Queries**

A **subquery** is a query within another query, often used to filter data or perform operations like aggregation.

## **4.1 Simple Subquery**

A **simple subquery** is placed in the **WHERE** or **HAVING** clause. It can return a single value or a list of values to be used in the outer query.

**Example** (Subquery in WHERE clause):

```sql
SELECT id, name
FROM employees
WHERE department_id IN (SELECT id FROM departments WHERE department_name = 'HR');
```

This query first retrieves the `id` of the departments that have the name "HR" and then selects all employees who belong to those departments.

## **4.2 Correlated Subquery**

A **correlated subquery** is a subquery that depends on the outer query for its values. It’s usually found in the **WHERE** clause, where the subquery uses a column from the outer query.

**Example**:

```sql
SELECT e.id, e.name
FROM employees e
WHERE e.salary > (SELECT AVG(salary) FROM employees WHERE department_id = e.department_id);
```

This query selects employees whose salary is greater than the average salary of their respective department. The subquery references the `department_id` of the outer query.

---

## **5. Complex Data Types in Hive (Arrays, Maps, Structs)**

Hive supports complex data types, which allow you to work with more structured and flexible data, such as arrays, maps, and structs.

## **5.1 Arrays**

An **ARRAY** is an ordered collection of elements, where all elements must have the same type.

**Syntax**:

```sql
ARRAY<data_type>
```

**Example**:

```sql
CREATE TABLE employee_skills (
    id INT,
    name STRING,
    skills ARRAY<STRING>
);
```

* This creates a table where each employee can have multiple skills stored in an array.

**Query Example**:

```sql
SELECT name, skills[0] AS first_skill
FROM employee_skills;
```

This query retrieves the first skill of each employee from the array.

## **5.2 Maps**

A **MAP** is a collection of key-value pairs where the keys and values can be of any data type.

**Syntax**:

```sql
MAP<key_data_type, value_data_type>
```

**Example**:

```sql
CREATE TABLE employee_details (
    id INT,
    name STRING,
    contact_info MAP<STRING, STRING>
);
```

* This creates a table where each employee has a map of contact information, such as phone numbers, email addresses, etc.

**Query Example**:

```sql
SELECT name, contact_info['email'] AS email
FROM employee_details;
```

This query retrieves the email from the map of contact information for each employee.

## **5.3 Structs**

A **STRUCT** is a collection of fields with different data types, similar to a row in a table.

**Syntax**:

```sql
STRUCT<field1_name: field1_type, field2_name: field2_type, ...>
```

**Example**:

```sql
CREATE TABLE employee (
    id INT,
    name STRING,
    address STRUCT<street:STRING, city:STRING, zip:STRING>
);
```

* This creates a table where each employee has an address, which is stored as a struct with `street`, `city`, and `zip`.

**Query Example**:

```sql
SELECT name, address.city
FROM employee;
```

This query retrieves the city field from the `address` struct for each employee.

---

## **Conclusion**

Hive Query Language (HQL) offers a powerful SQL-like interface to interact with large datasets stored in Hadoop. By understanding how to work with **basic queries**, **JOINs**, **aggregations**, **subqueries**, and **complex data types** like **arrays**, **maps**, and **structs**, you can leverage Hive for advanced analytics and big data processing. These capabilities enable users to query and manipulate data efficiently in a Hadoop environment.

If you need further details or examples on any of these concepts, feel free to ask!
